<div class="center-register-container">
  <p-toast></p-toast>
  <div class="stepper-wrapper">
    <p-steps [model]="steps" [readonly]="false" [activeIndex]="activeStepIndex"></p-steps>
  </div>

  <div class="step-content mt-4">
    <!-- Step 1: User Details -->
    <form *ngIf="activeStepIndex === 0" #userForm="ngForm" class="step-panel">
      <div class="field mb-3">
        <label for="username" class="form-label">Username</label>
        <input type="text" pInputText id="username" name="username" [(ngModel)]="user.username" class="form-control" required minlength="8" #usernameInput="ngModel" />
        <div *ngIf="usernameInput.invalid && usernameInput.touched" class="text-danger mt-1">
          <small *ngIf="usernameInput.errors?.['required']">Username is required</small>
          <small *ngIf="usernameInput.errors?.['minlength']">Username must be at least 8 characters</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" pInputText id="email" name="email" [(ngModel)]="user.email" class="form-control" required minlength="6" #emailInput="ngModel" />
        <div *ngIf="emailInput.invalid && emailInput.touched" class="text-danger mt-1">
          <small *ngIf="emailInput.errors?.['required']">Email is required</small>
          <small *ngIf="emailInput.errors?.['email']">Please enter a valid email address</small>
          <small *ngIf="emailInput.errors?.['minlength']">Email must be at least 6 characters</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="phoneNumber" class="form-label">Phone Number</label>
        <input type="tel" pInputText id="phoneNumber" name="phoneNumber" [(ngModel)]="user.phoneNumber" class="form-control" required minlength="8" #phoneInput="ngModel" />
        <div *ngIf="phoneInput.invalid && phoneInput.touched" class="text-danger mt-1">
          <small *ngIf="phoneInput.errors?.['required']">Phone number is required</small>
          <small *ngIf="phoneInput.errors?.['minlength']">Phone number must be at least 8 characters</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="password" class="form-label">Password</label>
        <div class="password-input-container">
          <input [type]="showPassword ? 'text' : 'password'" pInputText id="password" name="password" [(ngModel)]="user.password" class="form-control" required minlength="8" #passwordInput="ngModel" />
          <button type="button" class="password-toggle-btn" (click)="togglePasswordVisibility()">
            <i [class]="showPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"></i>
          </button>
        </div>
        <div *ngIf="passwordInput.invalid && passwordInput.touched" class="text-danger mt-1">
          <small *ngIf="passwordInput.errors?.['required']">Password is required</small>
          <small *ngIf="passwordInput.errors?.['minlength']">Password must be at least 8 characters</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <div class="password-input-container">
          <input [type]="showPassword ? 'text' : 'password'" pInputText id="confirmPassword" name="confirmPassword" [(ngModel)]="user.confirmPassword" class="form-control" required minlength="8" #confirmPasswordInput="ngModel" />
          <button type="button" class="password-toggle-btn" (click)="togglePasswordVisibility()">
            <i [class]="showPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"></i>
          </button>
        </div>
        <div *ngIf="confirmPasswordInput.invalid && confirmPasswordInput.touched" class="text-danger mt-1">
          <small *ngIf="confirmPasswordInput.errors?.['required']">Please confirm your password</small>
          <small *ngIf="confirmPasswordInput.errors?.['minlength']">Confirm password must be at least 8 characters</small>
        </div>
        <div *ngIf="user.password !== user.confirmPassword && user.confirmPassword" class="text-danger mt-1">
          <small>Passwords do not match</small>
        </div>
      </div>
      <input type="hidden" name="role" [(ngModel)]="user.role" />
    </form>

    <!-- Step 2: Owner Details -->
    <form *ngIf="activeStepIndex === 1" #ownerForm="ngForm" class="step-panel">
      <div class="field mb-3">
        <label for="firstName" class="form-label">First Name</label>
        <input type="text" pInputText id="firstName" name="firstName" [(ngModel)]="owner.firstName" class="form-control" required #firstNameInput="ngModel" />
        <div *ngIf="firstNameInput.invalid && firstNameInput.touched" class="text-danger mt-1">
          <small>First name is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="lastName" class="form-label">Last Name</label>
        <input type="text" pInputText id="lastName" name="lastName" [(ngModel)]="owner.lastName" class="form-control" required #lastNameInput="ngModel" />
        <div *ngIf="lastNameInput.invalid && lastNameInput.touched" class="text-danger mt-1">
          <small>Last name is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="gender" class="form-label">Gender</label>
        <p-dropdown id="gender" name="gender" [options]="genderOptions" [(ngModel)]="owner.gender" placeholder="Select gender" class="w-100" [required]="true" #genderInput="ngModel"></p-dropdown>
        <div *ngIf="genderInput.invalid && genderInput.touched" class="text-danger mt-1">
          <small>Gender is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="image" class="form-label">Profile Image</label>
        <input type="file" id="image" name="image" (change)="onFileSelected($event)" class="form-control" accept="image/*" />
      </div>
    </form>

    <!-- Step 3: Center Details -->
    <form *ngIf="activeStepIndex === 2" #centerForm="ngForm" class="step-panel">
      <div class="field mb-3">
        <label for="centerName" class="form-label">Center Name</label>
        <input type="text" pInputText id="centerName" name="centerName" [(ngModel)]="center.centerName" class="form-control" required #centerNameInput="ngModel" />
        <div *ngIf="centerNameInput.invalid && centerNameInput.touched" class="text-danger mt-1">
          <small>Center name is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="contactNumber" class="form-label">Contact Number</label>
        <input type="tel" pInputText id="contactNumber" name="contactNumber" [(ngModel)]="center.contactNumber" class="form-control" required #contactNumberInput="ngModel" />
        <div *ngIf="contactNumberInput.invalid && contactNumberInput.touched" class="text-danger mt-1">
          <small>Contact number is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="centerStreet" class="form-label">Street</label>
        <input type="text" pInputText id="centerStreet" name="centerStreet" [(ngModel)]="center.centerStreet" class="form-control" required #centerStreetInput="ngModel" />
        <div *ngIf="centerStreetInput.invalid && centerStreetInput.touched" class="text-danger mt-1">
          <small>Street is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="centerCity" class="form-label">City</label>
        <input type="text" pInputText id="centerCity" name="centerCity" [(ngModel)]="center.centerCity" class="form-control" required #centerCityInput="ngModel" />
        <div *ngIf="centerCityInput.invalid && centerCityInput.touched" class="text-danger mt-1">
          <small>City is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="centerCountry" class="form-label">Country</label>
        <input type="text" pInputText id="centerCountry" name="centerCountry" [(ngModel)]="center.centerCountry" class="form-control" required #centerCountryInput="ngModel" />
        <div *ngIf="centerCountryInput.invalid && centerCountryInput.touched" class="text-danger mt-1">
          <small>Country is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="centerEmail" class="form-label">Center Email</label>
        <input type="email" pInputText id="centerEmail" name="centerEmail" [(ngModel)]="center.centerEmail" class="form-control" required #centerEmailInput="ngModel" />
        <div *ngIf="centerEmailInput.invalid && centerEmailInput.touched" class="text-danger mt-1">
          <small>Email is required</small>
          <small *ngIf="centerEmailInput.errors?.['email']">Please enter a valid email address</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="websiteUrl" class="form-label">Website URL (optional)</label>
        <input type="text" pInputText id="websiteUrl" name="websiteUrl" [(ngModel)]="center.websiteUrl" class="form-control" />
      </div>
      <div class="field mb-3">
        <label for="centerGovernorate" class="form-label">Governorate</label>
        <input type="text" pInputText id="centerGovernorate" name="centerGovernorate" [(ngModel)]="center.centerGovernorate" class="form-control" required #centerGovernorateInput="ngModel" />
        <div *ngIf="centerGovernorateInput.invalid && centerGovernorateInput.touched" class="text-danger mt-1">
          <small>Governorate is required</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="latitude" class="form-label">Latitude (optional)</label>
        <input type="text" pInputText id="latitude" name="latitude" [(ngModel)]="center.latitude" class="form-control" inputmode="decimal" pattern="^-?\\d+(\\.\\d+)?$" />
        <div *ngIf="center.latitude && !isValidDecimal(center.latitude)" class="text-danger mt-1">
          <small>Latitude must be a valid decimal number</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="longitude" class="form-label">Longitude (optional)</label>
        <input type="text" pInputText id="longitude" name="longitude" [(ngModel)]="center.longitude" class="form-control" inputmode="decimal" pattern="^-?\\d+(\\.\\d+)?$" />
        <div *ngIf="center.longitude && !isValidDecimal(center.longitude)" class="text-danger mt-1">
          <small>Longitude must be a valid decimal number</small>
        </div>
      </div>
      <div class="field mb-3">
        <label for="mapUrl" class="form-label">Map URL (optional)</label>
        <input type="text" pInputText id="mapUrl" name="mapUrl" [(ngModel)]="center.mapUrl" class="form-control" />
      </div>
    </form>
  </div>

  <!-- Navigation Buttons -->
  <div class="step-navigation mt-4 d-flex justify-content-between">
    <button pButton type="button" label="Previous" icon="pi pi-chevron-left" class="p-button-secondary" *ngIf="activeStepIndex > 0" (click)="previousStep()"></button>
    <div class="ms-auto">
      <button pButton type="button" label="Next" icon="pi pi-chevron-right" iconPos="right" class="p-button-primary" *ngIf="activeStepIndex < 2" (click)="nextStep()" [disabled]="!isCurrentStepValid()"></button>
      <button pButton type="button" label="Register Center" icon="pi pi-check" class="p-button-success" *ngIf="activeStepIndex === 2" (click)="onRegister()" [disabled]="!isCurrentStepValid() || isLoading">
        <span *ngIf="isLoading" class="pi pi-spin pi-spinner"></span>
      </button>
    </div>
  </div>
</div>
