<div *ngIf="isLoading" class="loading modern-loading"><span>Loading...</span></div>

<div *ngIf="errorMessage && !isLoading" class="error-popup">
  <div class="error-popup-content">
    <i class="fas fa-exclamation-triangle error-icon"></i>
    <span>{{ errorMessage }}</span>
    <button class="close-btn" (click)="errorMessage = ''" aria-label="Close">×</button>
  </div>
</div>

<div *ngIf="successMessage && !isLoading" class="success-popup">
  <div class="success-popup-content">
    <i class="fas fa-check-circle success-icon"></i>
    <span>{{ successMessage }}</span>
    <button class="close-btn" (click)="successMessage = ''" aria-label="Close">×</button>
  </div>
</div>

<h1 class="page-title">Reschedule Assignments</h1>

<div *ngIf="!isLoading && !errorMessage" class="schedule-container modern-card">

  <div class="navigation-buttons">
    <button class="btn-secondary" (click)="toggleMode()" [ngClass]="{'active': !isWeeklyMode}">Manually</button>
    <button class="btn-primary" (click)="toggleMode()" [ngClass]="{'active': isWeeklyMode}">Weekly</button>
  </div>

  <form [formGroup]="scheduleForm" class="schedule-form">
    <div class="schedule-flex-row">
      <div class="calendar-section modern-card">
        <h2 class="inner-title">Select {{ isWeeklyMode ? 'Start Date' : 'Date Range' }}</h2>
        <div class="calendar-controls">
          <button type="button" class="nav-button" (click)="prevMonth()">◄</button>
          <span class="month-title">{{ getMonthName() }}</span>
          <button type="button" class="nav-button" (click)="nextMonth()">►</button>
        </div>
        <div class="calendar-wrapper modern-calendar-wrapper">
          <div class="calendar-header">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
          </div>
          <div class="calendar-body">
            <div *ngFor="let day of daysInMonth" class="calendar-day" [ngClass]="{
                'today': isToday(day.date),
                'start-date': isSelectedStartDate(day.date),
                'end-date': isSelectedEndDate(day.date),
                'in-between': isInRange(day.date)
              }" (click)="selectDate(day)">
              <ng-container *ngIf="day.date as validDate">
                <div *ngIf="validDate.getMonth() === viewDate.getMonth()" class="day-number-wrapper">
                  <span class="day-number">{{ validDate.getDate() }}</span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>

      <div class="shifts-section modern-card">
        <div formArrayName="assignments">
          <div *ngFor="let assignment of assignmentsArray.controls; let i = index" [formGroupName]="i" class="shift-card">
            <div class="shift-card-header">
              <div class="shift-header-content">
                <span class="shift-label" *ngIf="isWeeklyMode">Assignment {{ i + 1 }}</span>
                <button type="button" class="btn btn-danger btn-remove-shift" (click)="removeAssignment(i)" *ngIf="isWeeklyMode && assignmentsArray.length > 1">
                  Remove
                </button>
              </div>
            </div>

            <div *ngIf="isWeeklyMode" class="working-days-section">
              <h4 class="inner-title">Choose Days</h4>
              <div class="working-days">
                <mat-checkbox *ngFor="let day of daysOfWeek" [checked]="isWorkingDaySelected(day.value, i)"
                  (change)="onWorkingDayChange(day.value, $event.checked, i)">
                  {{ day.label }}
                </mat-checkbox>
              </div>
            </div>

            <div class="shifts-section">
              <div formArrayName="Shifts" *ngFor="let shift of getShifts(i).controls; let j = index">
                <div [formGroupName]="j" class="shift-fields">
                  <div class="shift-fields-header" *ngIf="!isWeeklyMode">
                    <span class="shift-label-inner">Shift {{ j + 1 }}</span>
                    <button type="button" class="btn btn-danger btn-remove-shift" (click)="removeShift(i, j)" *ngIf="!isWeeklyMode && getShifts(i).length > 1">
                      Remove
                    </button>
                  </div>
                  <div class="form-group" *ngIf="!isWeeklyMode">
                    <label class="form-label">Select Date</label>
                    <mat-select formControlName="Date" required class="form-control">
                      <mat-option *ngFor="let date of dateOptions" [value]="date">
                        {{ date.toLocaleDateString() }}
                      </mat-option>
                    </mat-select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Start Time</label>
                    <input type="time" formControlName="StartTime" required class="form-control" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">End Time</label>
                    <input type="time" formControlName="EndTime" required class="form-control" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Patients Number</label>
                    <input type="number" formControlName="MaxPatientsPerDay" min="1" class="form-control" />
                  </div>
                </div>
              </div>
              <div class="add-shift-action">
                <button type="button" class="btn btn-primary queue-btn" (click)="isWeeklyMode ? addAssignment() : addShift(i)">
                  <i class="fas fa-plus"></i> Add {{ isWeeklyMode ? 'Assignment' : 'Shift' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn-primary" (click)="onSubmit()" [disabled]="scheduleForm.invalid || isLoading">
        Reschedule
      </button>
    </div>
  </form>
</div>
