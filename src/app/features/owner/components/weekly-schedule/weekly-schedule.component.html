<div *ngIf="isLoading" class="loading modern-loading"><span>Loading...</span></div>

<div *ngIf="errorMessage && !isLoading" class="error-popup">
  <div class="error-popup-content">
    <i class="fas fa-exclamation-triangle error-icon"></i>
    <span>{{ errorMessage }}</span>
    <button class="close-btn" (click)="errorMessage = ''" aria-label="Close">&times;</button>
  </div>
</div>

<div *ngIf="successMessage && !isLoading" class="success-popup">
  <div class="success-popup-content">
    <i class="fas fa-check-circle success-icon"></i>
    <span>{{ successMessage }}</span>
    <button class="close-btn" (click)="successMessage = ''" aria-label="Close">&times;</button>
  </div>
</div>

<h1 class="page-title">Schedule Assignments</h1>
<hr class="mb-4">


<div *ngIf="provider && !isLoading && !errorMessage" class="schedule-container modern-card">
  <div class="provider-info-modern">
    <!-- <span class="doctor-name">Doctor Name: {{ provider.FirstName || 'Unknown' }} {{ provider.LastName || '' }}</span> -->
    <!-- <span class="doctor-specialty">Specialization: {{ provider.Specialization || 'N/A' }}</span> -->
  </div>

  <div class="navigation-buttons">
    <button class="btn-primary" (click)="ManuallySchedule()">Manually</button>
    <button class="btn-secondary" (click)="WeeklySchedule()">Weekly</button>
  </div>

  <form [formGroup]="scheduleForm" class="schedule-form">
    <div class="schedule-flex-row">
      <div class="calendar-section modern-card">
        <h2 class="inner-title">Select Start Date</h2>
        <div class="calendar-controls">
          <button type="button" class="nav-button" (click)="prevMonth()">◄</button>
          <span class="month-title">{{ getMonthName() }}</span>
          <button type="button" class="nav-button" (click)="nextMonth()">►</button>
        </div>
        <div class="calendar-wrapper modern-calendar-wrapper">
          <div class="calendar-header">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
          </div>
          <div class="calendar-body">
            <div *ngFor="let day of daysInMonth" class="calendar-day" [ngClass]="{
                   'today': isToday(day.date),
                   'disabled': day.hasAssignment,
                   'start-date': isSelectedStartDate(day.date)
                 }" (click)="selectDate(day)">
              <ng-container *ngIf="day.date as validDate">
                <div *ngIf="validDate.getMonth() === viewDate.getMonth()" class="day-number-wrapper">
                  <span class="day-number">{{ validDate.getDate() }}</span>
                  <span *ngIf="day.hasAssignment" class="assignment-dot"></span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>

      <div class="shifts-section modern-card">
        <form [formGroup]="scheduleForm" class="schedule-form">
          <div formArrayName="assignments">
            <div *ngFor="let assignment of assignments.controls; let i = index" [formGroupName]="i" class="shift-card">
              <div class="shift-card-header">
                <span class="shift-label">Assignment {{ i + 1 }}</span>
                <button type="button" class="btn btn-danger btn-remove-shift" (click)="removeAssignment(i)" *ngIf="assignments.length > 1">
                  Remove
                </button>
              </div>
              <div class="working-days-section">
                <h4 class="inner-title">Choose Days</h4>
                <div class="working-days">
                  <mat-checkbox *ngFor="let day of daysOfWeek" [checked]="isWorkingDaySelected(day.value, i)" (change)="onWorkingDayChange(day.value, $event.checked, i)">
                    {{ day.label }}
                  </mat-checkbox>
                </div>
              </div>
              <div class="shifts-section">
                <div formArrayName="Shifts" *ngFor="let shift of getShifts(i).controls; let j = index">
                  <div [formGroupName]="j" class="shift-fields">
                    <div class="form-group">
                      <label class="form-label">Start Time</label>
                      <input type="time" formControlName="StartTime" required class="form-control" />
                    </div>
                    <div class="form-group">
                      <label class="form-label">End Time</label>
                      <input type="time" formControlName="EndTime" required class="form-control" />
                    </div>
                    <div class="form-group">
                      <label class="form-label">Patients Number</label>
                      <input type="number" formControlName="MaxPatientsPerDay" min="1" class="form-control" />
                    </div>
                    <button type="button" class="btn btn-danger btn-remove-shift" (click)="removeShift(i, j)" *ngIf="getShifts(i).length > 1">
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div class="add-queue">
          <button type="button" class="btn btn-primary queue-btn" (click)="addAssignment()">
            <i class="fas fa-plus"></i> Add Assignment
          </button>
        </div>
      </div>
    </div>
    <div class="actions">
      <button type="button" class="btn-primary" (click)="onSubmit()" [disabled]="scheduleForm.invalid || isLoading">
        Submit
      </button>
    </div>
  </form>
</div>
